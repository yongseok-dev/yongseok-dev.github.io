<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL 성취도 평가</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      [v-cloak] {
        display: none;
      }
      .question-card {
        transition: all 0.3s ease;
      }
      .choice-card {
        transition: all 0.2s ease;
      }
      .choice-card:hover {
        transform: translateX(4px);
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
      .slide-enter-active,
      .slide-leave-active {
        transition: all 0.3s ease;
      }
      .slide-enter-from {
        transform: translateX(20px);
        opacity: 0;
      }
      .slide-leave-to {
        transform: translateX(-20px);
        opacity: 0;
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 transition-colors">
    <div id="app" v-cloak>
      <!-- Header -->
      <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
          <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">
              <i class="fas fa-database"></i> SQL 성취도 평가
            </h1>
            <div class="flex items-center gap-4">
              <button
                @click="toggleDarkMode"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                <i
                  :class="darkMode ? 'fas fa-sun text-yellow-400' : 'fas fa-moon text-gray-600'"
                ></i>
              </button>
              <button
                v-if="currentView === 'quiz'"
                @click="toggleTimer"
                class="px-3 py-1 text-sm rounded-lg"
                :class="timerEnabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
              >
                <i class="fas fa-clock"></i> {{ timerEnabled ?
                formatTime(elapsedTime) : '타이머' }}
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Loading State -->
      <div v-if="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
          <p class="text-gray-600 dark:text-gray-400">문제를 불러오는 중...</p>
        </div>
      </div>

      <!-- Error State -->
      <div
        v-else-if="error"
        class="flex items-center justify-center min-h-screen"
      >
        <div
          class="text-center bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-md"
        >
          <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
          <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">
            오류 발생
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">{{ error }}</p>
          <button
            @click="loadCSV"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            다시 시도
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <main v-else class="container mx-auto px-4 py-8">
        <!-- Home Screen -->
        <div v-if="currentView === 'home'" class="max-w-4xl mx-auto">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-6">
            <h2
              class="text-3xl font-bold text-gray-800 dark:text-white mb-4 text-center"
            >
              SQL 성취도 평가에 오신 것을 환영합니다!
            </h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-8">
              총 {{ questions.length }}문제로 구성된 SQL 평가를 시작하세요.
            </p>

            <!-- Statistics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
              <div
                class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg text-center"
              >
                <div
                  class="text-3xl font-bold text-blue-600 dark:text-blue-400"
                >
                  {{ questions.length }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  전체 문제
                </div>
              </div>
              <div
                class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg text-center"
              >
                <div
                  class="text-3xl font-bold text-green-600 dark:text-green-400"
                >
                  {{ Object.keys(categoryStats).length }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  카테고리
                </div>
              </div>
              <div
                class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg text-center"
              >
                <div
                  class="text-3xl font-bold text-purple-600 dark:text-purple-400"
                >
                  {{ answeredCount }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  풀이 완료
                </div>
              </div>
              <div
                class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg text-center"
              >
                <div
                  class="text-3xl font-bold text-yellow-600 dark:text-yellow-400"
                >
                  {{ correctCount }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  정답 수
                </div>
              </div>
            </div>

            <!-- Category Filter -->
            <div class="mb-6">
              <label
                class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
              >
                카테고리 필터 (선택사항)
              </label>
              <select
                v-model="selectedCategory"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white"
              >
                <option value="">전체 문제 ({{ questions.length }}문제)</option>
                <option
                  v-for="(count, category) in categoryStats"
                  :key="category"
                  :value="category"
                >
                  {{ category }} ({{ count }}문제)
                </option>
              </select>
            </div>

            <!-- Start Button -->
            <button
              @click="startQuiz"
              class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg transition-colors"
            >
              <i class="fas fa-play"></i> 시작하기
            </button>

            <!-- Resume Progress -->
            <div
              v-if="hasProgress"
              class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg"
            >
              <p class="text-yellow-800 dark:text-yellow-200 text-center">
                <i class="fas fa-info-circle"></i>
                진행 중인 퀴즈가 있습니다. 계속하시겠습니까?
              </p>
            </div>
          </div>

          <!-- Category Breakdown -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
              <i class="fas fa-list"></i> 카테고리별 문제 수
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <div
                v-for="(count, category) in categoryStats"
                :key="category"
                class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
              >
                <div class="font-semibold text-gray-800 dark:text-white">
                  {{ category }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  {{ count }}문제
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quiz Screen -->
        <div v-if="currentView === 'quiz'" class="flex gap-6">
          <!-- Sidebar -->
          <aside class="hidden lg:block w-64 flex-shrink-0">
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sticky top-24"
            >
              <h3 class="font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-list-ol"></i> 문제 목록
              </h3>
              <div class="max-h-96 overflow-y-auto">
                <div class="grid grid-cols-5 gap-2">
                  <button
                    v-for="(q, idx) in filteredQuestions"
                    :key="idx"
                    @click="currentQuestionIndex = idx"
                    class="w-10 h-10 rounded text-sm font-semibold transition-all"
                    :class="getQuestionButtonClass(idx)"
                  >
                    {{ idx + 1 }}
                  </button>
                </div>
              </div>
              <div
                class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"
              >
                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                  <div>
                    <span
                      class="inline-block w-3 h-3 bg-green-500 rounded mr-2"
                    ></span
                    >정답
                  </div>
                  <div>
                    <span
                      class="inline-block w-3 h-3 bg-red-500 rounded mr-2"
                    ></span
                    >오답
                  </div>
                  <div>
                    <span
                      class="inline-block w-3 h-3 bg-gray-300 rounded mr-2"
                    ></span
                    >미응답
                  </div>
                </div>
              </div>
            </div>
          </aside>

          <!-- Question Area -->
          <div class="flex-1">
            <!-- Progress Bar -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 mb-6"
            >
              <div
                class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-2"
              >
                <span>진행률</span>
                <span
                  >{{ answeredCount }} / {{ filteredQuestions.length }}</span
                >
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                <div
                  class="bg-blue-600 h-3 rounded-full transition-all"
                  :style="{width: progressPercentage + '%'}"
                ></div>
              </div>
            </div>

            <!-- Question Card -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 question-card"
            >
              <div class="flex justify-between items-center mb-4">
                <span
                  class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm font-semibold"
                >
                  {{ currentQuestion.분류 }}
                </span>
                <span class="text-gray-500 dark:text-gray-400 font-semibold">
                  문제 {{ currentQuestionIndex + 1 }} / {{
                  filteredQuestions.length }}
                </span>
              </div>

              <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                {{ currentQuestion.질문 }}
              </h3>

              <!-- Choices -->
              <div class="space-y-3 mb-6">
                <div
                  v-for="(choice, idx) in currentChoices"
                  :key="idx"
                  @click="!isAnswered ? selectAnswer(idx) : null"
                  class="choice-card p-4 rounded-lg border-2 cursor-pointer"
                  :class="getChoiceClass(idx)"
                >
                  <div class="flex items-start">
                    <input
                      type="radio"
                      :checked="selectedAnswer === idx"
                      :disabled="isAnswered"
                      class="mt-1 mr-3"
                    />
                    <span class="flex-1 text-gray-800 dark:text-white"
                      >{{ choice }}</span
                    >
                    <i
                      v-if="isAnswered && isCorrectAnswer(idx)"
                      class="fas fa-check-circle text-green-500 text-xl"
                    ></i>
                    <i
                      v-if="isAnswered && selectedAnswer === idx && !isCorrectAnswer(idx)"
                      class="fas fa-times-circle text-red-500 text-xl"
                    ></i>
                  </div>
                </div>
              </div>

              <!-- Explanation -->
              <div
                v-if="isAnswered"
                class="p-4 rounded-lg mb-6"
                :class="isCorrect ? 'bg-green-50 dark:bg-green-900/20 border-2 border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800'"
              >
                <div class="flex items-center mb-2">
                  <i
                    :class="isCorrect ? 'fas fa-check-circle text-green-600' : 'fas fa-times-circle text-red-600'"
                    class="text-2xl mr-2"
                  ></i>
                  <h4
                    class="font-bold"
                    :class="isCorrect ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'"
                  >
                    {{ isCorrect ? '정답입니다!' : '오답입니다!' }}
                  </h4>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-2">
                  <strong>정답:</strong> {{ currentQuestion.정답 }}
                </p>
                <p class="text-gray-700 dark:text-gray-300">
                  <strong>해설:</strong> {{ currentQuestion.해설 }}
                </p>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button
                  @click="previousQuestion"
                  :disabled="currentQuestionIndex === 0"
                  class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fas fa-chevron-left"></i> 이전
                </button>

                <button
                  v-if="!isAnswered"
                  @click="submitAnswer"
                  :disabled="selectedAnswer === null"
                  class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                >
                  답안 제출
                </button>

                <button
                  v-if="isAnswered && currentQuestionIndex < filteredQuestions.length - 1"
                  @click="nextQuestion"
                  class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                >
                  다음 문제 <i class="fas fa-chevron-right"></i>
                </button>

                <button
                  v-if="isAnswered && currentQuestionIndex === filteredQuestions.length - 1"
                  @click="finishQuiz"
                  class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                >
                  결과 보기 <i class="fas fa-flag-checkered"></i>
                </button>

                <button
                  @click="toggleBookmark"
                  class="px-4 py-3 rounded-lg transition-colors"
                  :class="isBookmarked ? 'bg-yellow-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-yellow-100 dark:hover:bg-yellow-900/20'"
                >
                  <i
                    :class="isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark'"
                  ></i>
                </button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex gap-3">
              <button
                @click="currentView = 'home'"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
              >
                <i class="fas fa-home"></i> 홈으로
              </button>
              <button
                @click="finishQuiz"
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
              >
                <i class="fas fa-chart-bar"></i> 결과 보기
              </button>
            </div>
          </div>
        </div>

        <!-- Results Screen -->
        <div v-if="currentView === 'results'" class="max-w-4xl mx-auto">
          <!-- Score Card -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-6 text-center"
          >
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
              <i class="fas fa-trophy text-yellow-500"></i> 퀴즈 완료!
            </h2>

            <div class="flex justify-center items-center gap-8 mb-6">
              <div class="text-center">
                <div
                  class="text-6xl font-bold"
                  :class="scorePercentage >= 80 ? 'text-green-600' : scorePercentage >= 60 ? 'text-yellow-600' : 'text-red-600'"
                >
                  {{ scorePercentage }}%
                </div>
                <div class="text-gray-600 dark:text-gray-400">점수</div>
              </div>
              <div class="text-center">
                <div
                  class="text-4xl font-bold text-blue-600 dark:text-blue-400"
                >
                  {{ correctCount }} / {{ answeredCount }}
                </div>
                <div class="text-gray-600 dark:text-gray-400">정답 / 응답</div>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-4 max-w-lg mx-auto">
              <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <div
                  class="text-2xl font-bold text-green-600 dark:text-green-400"
                >
                  {{ correctCount }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">정답</div>
              </div>
              <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                <div class="text-2xl font-bold text-red-600 dark:text-red-400">
                  {{ wrongCount }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">오답</div>
              </div>
              <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div
                  class="text-2xl font-bold text-gray-600 dark:text-gray-400"
                >
                  {{ unansweredCount }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  미응답
                </div>
              </div>
            </div>

            <div
              v-if="timerEnabled"
              class="mt-4 text-gray-600 dark:text-gray-400"
            >
              <i class="fas fa-clock"></i> 소요 시간: {{ formatTime(elapsedTime)
              }}
            </div>
          </div>

          <!-- Category Performance -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
              <i class="fas fa-chart-pie"></i> 카테고리별 성적
            </h3>
            <div class="space-y-3">
              <div
                v-for="(stats, category) in categoryPerformance"
                :key="category"
                class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
              >
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold text-gray-800 dark:text-white"
                    >{{ category }}</span
                  >
                  <span class="text-sm text-gray-600 dark:text-gray-400">
                    {{ stats.correct }} / {{ stats.total }} ({{
                    Math.round(stats.correct / stats.total * 100) }}%)
                  </span>
                </div>
                <div
                  class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2"
                >
                  <div
                    class="h-2 rounded-full transition-all"
                    :class="stats.correct / stats.total >= 0.8 ? 'bg-green-500' : stats.correct / stats.total >= 0.6 ? 'bg-yellow-500' : 'bg-red-500'"
                    :style="{width: (stats.correct / stats.total * 100) + '%'}"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Wrong Answers -->
          <div
            v-if="wrongAnswers.length > 0"
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6"
          >
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
              <i class="fas fa-times-circle text-red-500"></i> 오답 노트 ({{
              wrongAnswers.length }}문제)
            </h3>
            <div class="space-y-3">
              <div
                v-for="wrong in wrongAnswers"
                :key="wrong.index"
                class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"
              >
                <div class="flex justify-between items-start mb-2">
                  <span class="font-semibold text-gray-800 dark:text-white">
                    문제 {{ wrong.index + 1 }}: {{
                    wrong.question.질문.substring(0, 50) }}...
                  </span>
                  <button
                    @click="reviewQuestion(wrong.index)"
                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                  >
                    복습하기
                  </button>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  <span
                    class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded"
                  >
                    {{ wrong.question.분류 }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-4">
            <button
              @click="resetQuiz"
              class="flex-1 px-6 py-4 bg-blue-600 text-white text-lg font-bold rounded-lg hover:bg-blue-700"
            >
              <i class="fas fa-redo"></i> 다시 풀기
            </button>
            <button
              @click="reviewWrongAnswers"
              :disabled="wrongAnswers.length === 0"
              class="flex-1 px-6 py-4 bg-red-600 text-white text-lg font-bold rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <i class="fas fa-book"></i> 오답만 복습
            </button>
            <button
              @click="currentView = 'home'"
              class="flex-1 px-6 py-4 bg-gray-600 text-white text-lg font-bold rounded-lg hover:bg-gray-700"
            >
              <i class="fas fa-home"></i> 홈으로
            </button>
          </div>

          <!-- Export Results -->
          <div class="mt-4">
            <button
              @click="exportResults"
              class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              <i class="fas fa-download"></i> 결과 내보내기 (텍스트)
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            // Core data
            questions: [],
            loading: true,
            error: null,

            // UI state
            currentView: "home", // 'home', 'quiz', 'results'
            darkMode: false,

            // Quiz state
            selectedCategory: "",
            currentQuestionIndex: 0,
            userAnswers: {}, // { questionIndex: { selected: choiceIndex, correct: boolean, answered: true } }
            bookmarks: new Set(),

            // Timer
            timerEnabled: false,
            startTime: null,
            elapsedTime: 0,
            timerInterval: null,
          };
        },
        computed: {
          filteredQuestions() {
            if (!this.selectedCategory) return this.questions;
            return this.questions.filter(
              (q) => q.분류 === this.selectedCategory
            );
          },
          categoryStats() {
            const stats = {};
            this.questions.forEach((q) => {
              stats[q.분류] = (stats[q.분류] || 0) + 1;
            });
            return stats;
          },
          currentQuestion() {
            return this.filteredQuestions[this.currentQuestionIndex] || {};
          },
          currentChoices() {
            return [
              this.currentQuestion.선택지1,
              this.currentQuestion.선택지2,
              this.currentQuestion.선택지3,
              this.currentQuestion.선택지4,
            ];
          },
          selectedAnswer() {
            const answer = this.userAnswers[this.currentQuestionIndex];
            return answer ? answer.selected : null;
          },
          isAnswered() {
            return (
              this.userAnswers[this.currentQuestionIndex]?.answered || false
            );
          },
          isCorrect() {
            return (
              this.userAnswers[this.currentQuestionIndex]?.correct || false
            );
          },
          isBookmarked() {
            return this.bookmarks.has(this.currentQuestionIndex);
          },
          answeredCount() {
            return Object.values(this.userAnswers).filter((a) => a.answered)
              .length;
          },
          correctCount() {
            return Object.values(this.userAnswers).filter(
              (a) => a.answered && a.correct
            ).length;
          },
          wrongCount() {
            return Object.values(this.userAnswers).filter(
              (a) => a.answered && !a.correct
            ).length;
          },
          unansweredCount() {
            return this.filteredQuestions.length - this.answeredCount;
          },
          progressPercentage() {
            return this.filteredQuestions.length > 0
              ? Math.round(
                  (this.answeredCount / this.filteredQuestions.length) * 100
                )
              : 0;
          },
          scorePercentage() {
            return this.answeredCount > 0
              ? Math.round((this.correctCount / this.answeredCount) * 100)
              : 0;
          },
          wrongAnswers() {
            return this.filteredQuestions
              .map((q, idx) => ({ question: q, index: idx }))
              .filter((item) => {
                const answer = this.userAnswers[item.index];
                return answer && answer.answered && !answer.correct;
              });
          },
          categoryPerformance() {
            const performance = {};
            this.filteredQuestions.forEach((q, idx) => {
              const category = q.분류;
              if (!performance[category]) {
                performance[category] = { total: 0, correct: 0 };
              }
              const answer = this.userAnswers[idx];
              if (answer && answer.answered) {
                performance[category].total++;
                if (answer.correct) performance[category].correct++;
              }
            });
            return performance;
          },
          hasProgress() {
            return Object.keys(this.userAnswers).length > 0;
          },
        },
        methods: {
          async loadCSV() {
            this.loading = true;
            this.error = null;

            try {
              const response = await fetch("./SQL_성취도평가_100문제.csv");
              if (!response.ok) {
                throw new Error("CSV 파일을 찾을 수 없습니다.");
              }
              const csvText = await response.text();

              Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                  this.questions = results.data;
                  this.loading = false;

                  if (this.questions.length === 0) {
                    this.error = "CSV 파일에 문제가 없습니다.";
                  }
                },
                error: (error) => {
                  this.error = "CSV 파싱 오류: " + error.message;
                  this.loading = false;
                },
              });
            } catch (err) {
              this.error = err.message;
              this.loading = false;
            }
          },
          startQuiz() {
            this.currentView = "quiz";
            this.currentQuestionIndex = 0;
            if (this.timerEnabled && !this.startTime) {
              this.startTimer();
            }
          },
          selectAnswer(choiceIndex) {
            if (!this.isAnswered) {
              this.userAnswers[this.currentQuestionIndex] = {
                selected: choiceIndex,
                answered: false,
                correct: false,
              };
            }
          },
          submitAnswer() {
            if (this.selectedAnswer === null) return;

            const correctAnswerSymbol = this.currentQuestion.정답;
            const correctIndex =
              this.getChoiceIndexFromSymbol(correctAnswerSymbol);
            const isCorrect = this.selectedAnswer === correctIndex;

            this.userAnswers[this.currentQuestionIndex] = {
              selected: this.selectedAnswer,
              answered: true,
              correct: isCorrect,
            };
          },
          getChoiceIndexFromSymbol(symbol) {
            const symbols = ["①", "②", "③", "④"];
            return symbols.indexOf(symbol);
          },
          isCorrectAnswer(choiceIndex) {
            const correctAnswerSymbol = this.currentQuestion.정답;
            const correctIndex =
              this.getChoiceIndexFromSymbol(correctAnswerSymbol);
            return choiceIndex === correctIndex;
          },
          nextQuestion() {
            if (this.currentQuestionIndex < this.filteredQuestions.length - 1) {
              this.currentQuestionIndex++;
            }
          },
          previousQuestion() {
            if (this.currentQuestionIndex > 0) {
              this.currentQuestionIndex--;
            }
          },
          finishQuiz() {
            this.currentView = "results";
            this.stopTimer();
          },
          resetQuiz() {
            this.userAnswers = {};
            this.bookmarks = new Set();
            this.currentQuestionIndex = 0;
            this.elapsedTime = 0;
            this.startTime = null;
            this.currentView = "home";
          },
          reviewWrongAnswers() {
            // Filter to show only wrong answers
            this.currentView = "quiz";
            this.currentQuestionIndex = this.wrongAnswers[0]?.index || 0;
          },
          reviewQuestion(index) {
            this.currentView = "quiz";
            this.currentQuestionIndex = index;
          },
          toggleBookmark() {
            if (this.bookmarks.has(this.currentQuestionIndex)) {
              this.bookmarks.delete(this.currentQuestionIndex);
            } else {
              this.bookmarks.add(this.currentQuestionIndex);
            }
          },
          toggleDarkMode() {
            this.darkMode = !this.darkMode;
            document.documentElement.classList.toggle("dark", this.darkMode);
          },
          toggleTimer() {
            this.timerEnabled = !this.timerEnabled;
            if (this.timerEnabled && this.currentView === "quiz") {
              this.startTimer();
            } else {
              this.stopTimer();
            }
          },
          startTimer() {
            this.startTime = Date.now() - this.elapsedTime * 1000;
            this.timerInterval = setInterval(() => {
              this.elapsedTime = Math.floor(
                (Date.now() - this.startTime) / 1000
              );
            }, 1000);
          },
          stopTimer() {
            if (this.timerInterval) {
              clearInterval(this.timerInterval);
              this.timerInterval = null;
            }
          },
          formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, "0")}`;
          },
          getQuestionButtonClass(index) {
            const answer = this.userAnswers[index];
            const isCurrent = index === this.currentQuestionIndex;

            if (isCurrent) {
              return "bg-blue-600 text-white border-2 border-blue-800";
            }
            if (answer && answer.answered) {
              return answer.correct
                ? "bg-green-500 text-white hover:bg-green-600"
                : "bg-red-500 text-white hover:bg-red-600";
            }
            return "bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600";
          },
          getChoiceClass(choiceIndex) {
            const baseClass = "transition-all";

            if (!this.isAnswered) {
              return this.selectedAnswer === choiceIndex
                ? `${baseClass} bg-blue-100 dark:bg-blue-900/30 border-blue-500`
                : `${baseClass} bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700`;
            }

            if (this.isCorrectAnswer(choiceIndex)) {
              return `${baseClass} bg-green-100 dark:bg-green-900/30 border-green-500`;
            }

            if (
              this.selectedAnswer === choiceIndex &&
              !this.isCorrectAnswer(choiceIndex)
            ) {
              return `${baseClass} bg-red-100 dark:bg-red-900/30 border-red-500`;
            }

            return `${baseClass} bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 opacity-50`;
          },
          exportResults() {
            let text = "=== SQL 성취도 평가 결과 ===\n\n";
            text += `총점: ${this.correctCount} / ${this.answeredCount} (${this.scorePercentage}%)\n`;
            text += `정답: ${this.correctCount}개\n`;
            text += `오답: ${this.wrongCount}개\n`;
            text += `미응답: ${this.unansweredCount}개\n`;

            if (this.timerEnabled) {
              text += `소요 시간: ${this.formatTime(this.elapsedTime)}\n`;
            }

            text += "\n=== 카테고리별 성적 ===\n";
            for (const [category, stats] of Object.entries(
              this.categoryPerformance
            )) {
              const percentage = Math.round(
                (stats.correct / stats.total) * 100
              );
              text += `${category}: ${stats.correct}/${stats.total} (${percentage}%)\n`;
            }

            if (this.wrongAnswers.length > 0) {
              text += "\n=== 오답 노트 ===\n";
              this.wrongAnswers.forEach((wrong) => {
                text += `\n문제 ${wrong.index + 1}: ${wrong.question.질문}\n`;
                text += `정답: ${wrong.question.정답}\n`;
                text += `해설: ${wrong.question.해설}\n`;
              });
            }

            // Create download
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "SQL_성취도평가_결과.txt";
            a.click();
            URL.revokeObjectURL(url);
          },
        },
        mounted() {
          this.loadCSV();

          // Check system dark mode preference
          if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            this.darkMode = true;
            document.documentElement.classList.add("dark");
          }
        },
        beforeUnmount() {
          this.stopTimer();
        },
      }).mount("#app");
    </script>
  </body>
</html>
